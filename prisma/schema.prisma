generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// ─── Auth.js models ───────────────────────────────────────────

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  DELETED
}

model User {
  id            String     @id @default(uuid())
  name          String?
  email         String     @unique @db.VarChar(255)
  emailVerified DateTime?
  passwordHash  String?    @db.VarChar(255)
  role          Role       @default(USER)
  status        UserStatus @default(ACTIVE)
  disabled      Boolean    @default(false)
  image         String?
  lastLoginAt   DateTime?
  lastActiveAt  DateTime?
  deletedAt     DateTime?

  // Email marketing
  emailMarketingOptIn  Boolean   @default(false)
  marketingOptInAt     DateTime?
  emailUnsubscribed    Boolean   @default(false)
  unsubscribeToken     String?   @unique @db.VarChar(64)
  lastEmailEngagementAt DateTime?

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  accounts      Account[]
  sessions      Session[]
  profile       Profile?
  auditLogs     AdminAuditLog[]
  connectionsSent     ConnectionRequest[] @relation("ConnectionSender")
  connectionsReceived ConnectionRequest[] @relation("ConnectionReceiver")
  connectionsLow      Connection[]  @relation("ConnectionLow")
  connectionsHigh     Connection[]  @relation("ConnectionHigh")
  conversationParticipants ConversationParticipant[]
  messagesSent        Message[]
  meetupsCreated      Meetup[]
  meetupAttendances   MeetupAttendee[]
  blocksInitiated     Block[]  @relation("Blocker")
  blocksReceived      Block[]  @relation("Blocked")
  reports             Report[]
  securityEvents      UserSecurityEvent[]
  emailLogs           EmailLog[]
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Application models ──────────────────────────────────────

enum LeadStatus {
  NEW
  CONTACTED
  CONVERTED
  CLOSED
}

model Lead {
  id         String     @id @default(uuid())
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  name       String?
  email      String     @db.VarChar(255)
  message    String?    @db.Text
  source     String?
  status     LeadStatus @default(NEW)
  adminNotes String?    @db.Text
  deleted    Boolean    @default(false)

  @@index([email])
  @@index([createdAt])
  @@index([status])
}

model WaitlistEntry {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
}

model AdminAuditLog {
  id            String   @id @default(uuid())
  adminUserId   String
  actionType    String   @db.VarChar(50)
  targetType    String   @db.VarChar(50)
  targetId      String   @db.VarChar(191)
  targetUserId  String?  @db.VarChar(191)
  metadata      String?  @db.Text
  beforeJson    String?  @db.Text
  afterJson     String?  @db.Text
  createdAt     DateTime @default(now())

  admin         User     @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([targetUserId])
  @@index([createdAt])
}

// ─── Profile models ──────────────────────────────────────────

enum DegreeStatus {
  NONE
  IN_PROGRESS
  BACHELORS
  MASTERS
}

enum TeachingExperience {
  NONE
  LT1_YEAR
  ONE_TO_THREE
  THREE_PLUS
}

enum CertificationStatus {
  NONE
  IN_PROGRESS
  COMPLETED
}

enum TargetCountry {
  VIETNAM
  THAILAND
  CAMBODIA
  INDONESIA
  PHILIPPINES
  MALAYSIA
}

enum DesiredStartTimeline {
  ASAP
  ONE_TO_THREE_MONTHS
  THREE_TO_SIX_MONTHS
  RESEARCHING
}

enum SavingsBand {
  LOW
  MEDIUM
  HIGH
}

enum RelocationStage {
  PLANNING
  SECURED_JOB
  ARRIVED
  TEACHING
  RENEWING_VISA
}

enum LookingFor {
  FIRST_JOB
  BETTER_SCHOOL
  FLATMATES
  LANGUAGE_EXCHANGE
  FRIENDS
  TRAVEL_BUDDIES
}

enum ReplyTimeHint {
  WITHIN_HOUR
  WITHIN_FEW_HOURS
  WITHIN_DAY
  NOT_ACTIVE
}

enum ActivityEventType {
  COMMENTED
  RSVP
  POSTED
  CONNECTED
}

model Profile {
  id                    String              @id @default(uuid())
  userId                String              @unique
  passportCountry       String?             @db.VarChar(100)
  degreeStatus          DegreeStatus        @default(NONE)
  nativeEnglish         Boolean             @default(false)
  teachingExperience    TeachingExperience  @default(NONE)
  certificationStatus   CertificationStatus @default(NONE)
  desiredStartTimeline  DesiredStartTimeline @default(RESEARCHING)
  savingsBand           SavingsBand         @default(MEDIUM)
  displayName           String?             @db.VarChar(50)
  bio                   String?             @db.Text
  currentCountry        String?             @db.VarChar(100)
  currentCity           String?             @db.VarChar(100)
  avatarUrl             String?             @db.VarChar(500)
  visibility            ProfileVisibility   @default(MEMBERS_ONLY)
  meetupCoffee          Boolean             @default(false)
  meetupCityTour        Boolean             @default(false)
  meetupJobAdvice       Boolean             @default(false)
  meetupStudyGroup      Boolean             @default(false)
  meetupLanguageExchange Boolean            @default(false)
  meetupVisaHelp        Boolean             @default(false)
  meetupSchoolReferrals Boolean             @default(false)
  meetupExploring       Boolean             @default(false)
  hiddenFromCommunity   Boolean             @default(false)

  // ── New community profile fields ───────────────────────
  relocationStage       RelocationStage     @default(PLANNING)
  lookingFor            LookingFor?         
  replyTimeHint         ReplyTimeHint?      
  certifications        Json?               // string[] e.g. ["TEFL/TESOL", "CELTA"]
  languagesTeaching     Json?               // string[] e.g. ["English"]
  interests             Json?               // string[] e.g. ["Motorbikes", "Coffee shops"]
  showCityPublicly      Boolean             @default(true)
  phoneVerified         Boolean             @default(false)

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetCountries       ProfileTargetCountry[]
  images                ProfileImage[]
  activityEvents        ActivityEvent[]

  @@index([currentCountry])
  @@index([currentCity])
  @@index([visibility])
  @@index([updatedAt])
}

model ProfileTargetCountry {
  id        String        @id @default(uuid())
  profileId String
  country   TargetCountry

  profile   Profile       @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, country])
  @@index([profileId])
}

model ProfileImage {
  id        String   @id @default(uuid())
  profileId String
  url       String   @db.VarChar(500)
  caption   String?  @db.VarChar(200)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

model ActivityEvent {
  id          String            @id @default(uuid())
  profileId   String
  eventType   ActivityEventType
  title       String            @db.VarChar(300)
  linkUrl     String?           @db.VarChar(500)
  createdAt   DateTime          @default(now())

  profile     Profile           @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, createdAt])
}

// ─── Community enums ─────────────────────────────────────────

enum ProfileVisibility {
  PRIVATE
  MEMBERS_ONLY
  PUBLIC
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

enum MeetupVisibility {
  MEMBERS_ONLY
  PUBLIC
}

enum MeetupStatus {
  ACTIVE
  CANCELLED
}

enum AttendeeStatus {
  GOING
  INTERESTED
  LEFT
}

enum ReportTargetType {
  USER
  MEETUP
}

enum ReportReason {
  SPAM
  HARASSMENT
  SCAM
  OTHER
}

// ─── Community models ────────────────────────────────────────

model ConnectionRequest {
  id         String           @id @default(uuid())
  fromUserId String
  toUserId   String
  status     ConnectionStatus @default(PENDING)
  message    String?          @db.VarChar(300)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  fromUser   User             @relation("ConnectionSender", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User             @relation("ConnectionReceiver", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@index([toUserId])
  @@index([status])
  @@index([createdAt])
}

model Meetup {
  id              String           @id @default(uuid())
  createdByUserId String
  title           String           @db.VarChar(200)
  description     String           @db.Text
  country         String           @db.VarChar(100)
  city            String           @db.VarChar(100)
  dateTime        DateTime
  locationHint    String?          @db.VarChar(200)
  maxAttendees    Int?
  visibility      MeetupVisibility @default(MEMBERS_ONLY)
  status          MeetupStatus     @default(ACTIVE)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  createdBy       User             @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  attendees       MeetupAttendee[]

  @@index([country])
  @@index([city])
  @@index([dateTime])
  @@index([status])
  @@index([createdByUserId])
}

model MeetupAttendee {
  id        String         @id @default(uuid())
  meetupId  String
  userId    String
  status    AttendeeStatus @default(GOING)
  createdAt DateTime       @default(now())

  meetup    Meetup         @relation(fields: [meetupId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([meetupId, userId])
  @@index([userId])
}

model Block {
  id            String   @id @default(uuid())
  blockerUserId String
  blockedUserId String
  createdAt     DateTime @default(now())

  blocker       User     @relation("Blocker", fields: [blockerUserId], references: [id], onDelete: Cascade)
  blocked       User     @relation("Blocked", fields: [blockedUserId], references: [id], onDelete: Cascade)

  @@unique([blockerUserId, blockedUserId])
  @@index([blockedUserId])
}

model Report {
  id             String           @id @default(uuid())
  reporterUserId String
  targetType     ReportTargetType
  targetId       String           @db.VarChar(191)
  reason         ReportReason
  details        String?          @db.VarChar(1000)
  createdAt      DateTime         @default(now())

  reporter       User             @relation(fields: [reporterUserId], references: [id], onDelete: Cascade)

  @@index([reporterUserId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// ─── Canonical connections (new system) ──────────────────────

enum CanonicalConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Connection {
  id               String                    @id @default(uuid())
  userLowId        String
  userHighId       String
  requestedByUserId String
  status           CanonicalConnectionStatus @default(PENDING)
  createdAt        DateTime                  @default(now())
  acceptedAt       DateTime?
  updatedAt        DateTime                  @updatedAt

  userLow          User @relation("ConnectionLow",  fields: [userLowId],  references: [id], onDelete: Cascade)
  userHigh         User @relation("ConnectionHigh", fields: [userHighId], references: [id], onDelete: Cascade)

  @@unique([userLowId, userHighId])
  @@index([userHighId])
  @@index([status])
  @@index([requestedByUserId])
}

// ─── Messaging (DMs) ────────────────────────────────────────

enum ConversationType {
  DM
}

model Conversation {
  id           String             @id @default(uuid())
  type         ConversationType   @default(DM)
  createdAt    DateTime           @default(now())

  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  lastReadAt     DateTime?

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  body           String       @db.Text
  createdAt      DateTime     @default(now())
  deletedAt      DateTime?

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
}

// ─── Security events ────────────────────────────────────────

model UserSecurityEvent {
  id        String   @id @default(uuid())
  userId    String
  eventType String   @db.VarChar(50)
  ipAddress String?  @db.VarChar(45)
  userAgent String?  @db.VarChar(500)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

// ─── IP blocking ────────────────────────────────────────────

model BlockedIp {
  id        String    @id @default(uuid())
  ipCidr    String    @db.VarChar(50)
  reason    String?   @db.VarChar(500)
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([ipCidr])
  @@index([expiresAt])
}

// ─── AI Blog Generator ─────────────────────────────────────

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

enum ArticleConfidence {
  HIGH
  LOW
}

enum ArticleRunStatus {
  RUNNING
  SUCCESS
  FAILED
}

enum ArticleImageKind {
  HERO
  OG
  INLINE
}

model GeneratedArticleDraft {
  id                 String             @id @default(uuid())
  city               String             @db.VarChar(100)
  topic              String             @db.VarChar(200)
  audience           String             @db.VarChar(100)
  targetKeyword      String?            @db.VarChar(200)
  secondaryKeywords  String?            @db.Text
  title              String             @db.VarChar(300)
  slug               String             @unique @db.VarChar(300)
  metaTitle          String             @db.VarChar(200)
  metaDescription    String             @db.VarChar(500)
  markdown           String             @db.LongText
  html               String?            @db.LongText
  heroImageUrl       String?            @db.VarChar(2000)
  ogImageUrl         String?            @db.VarChar(2000)
  imagesJson         Json?
  status             ArticleStatus      @default(DRAFT)
  confidence         ArticleConfidence  @default(HIGH)
  publishedAt        DateTime?
  updatedByUserId    String?            @db.VarChar(191)
  revisionNumber     Int                @default(1)
  lastSeoScore       Int?
  lastSeoCheckedAt   DateTime?
  seoIssuesJson      Json?
  canonicalUrl       String?            @db.VarChar(2000)
  schemaJson         Json?
  contentHash        String?            @db.VarChar(64)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  sources            GeneratedArticleSource[]
  runs               GeneratedArticleRun[]
  images             GeneratedArticleImage[]
  revisions          BlogRevision[]

  @@index([status])
  @@index([city])
  @@index([createdAt])
  @@index([publishedAt])
}

model BlogRevision {
  id                String   @id @default(uuid())
  postId            String
  revisionNumber    Int
  title             String   @db.VarChar(300)
  metaTitle         String   @db.VarChar(200)
  metaDescription   String   @db.VarChar(500)
  slug              String   @db.VarChar(300)
  markdown          String   @db.LongText
  html              String?  @db.LongText
  createdAt         DateTime @default(now())
  createdByUserId   String?  @db.VarChar(191)

  post              GeneratedArticleDraft @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([revisionNumber])
}

model GeneratedArticleImage {
  id          String           @id @default(uuid())
  draftId     String
  kind        ArticleImageKind
  prompt      String           @db.Text
  altText     String           @db.VarChar(500)
  caption     String?          @db.VarChar(500)
  width       Int
  height      Int
  mimeType    String           @db.VarChar(50)
  storageUrl  String           @db.VarChar(2000)
  createdAt   DateTime         @default(now())

  draft       GeneratedArticleDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId])
  @@index([kind])
}

model GeneratedArticleSource {
  id          String    @id @default(uuid())
  draftId     String
  url         String    @db.VarChar(2000)
  title       String?   @db.VarChar(500)
  publisher   String?   @db.VarChar(200)
  publishedAt DateTime?
  fetchedAt   DateTime  @default(now())
  excerpt     String?   @db.Text

  draft       GeneratedArticleDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId])
}

model GeneratedArticleRun {
  id           String           @id @default(uuid())
  draftId      String?
  startedAt    DateTime         @default(now())
  finishedAt   DateTime?
  status       ArticleRunStatus @default(RUNNING)
  error        String?          @db.Text
  modelUsed    String?          @db.VarChar(100)
  tokenUsage   Int?
  settingsJson String?          @db.Text

  draft        GeneratedArticleDraft? @relation(fields: [draftId], references: [id], onDelete: SetNull)

  @@index([draftId])
  @@index([status])
  @@index([startedAt])
}

// ─── Email System ───────────────────────────────────────────

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
}

enum EmailLogType {
  TRANSACTIONAL
  MARKETING
}

enum EmailLogStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

model EmailCampaign {
  id              String         @id @default(uuid())
  subject         String         @db.VarChar(500)
  previewText     String?        @db.VarChar(500)
  htmlContent     String         @db.LongText
  textContent     String?        @db.LongText
  segmentJson     Json?
  status          CampaignStatus @default(DRAFT)
  scheduledAt     DateTime?
  sentAt          DateTime?
  sentCount       Int            @default(0)
  deliveredCount  Int            @default(0)
  openCount       Int            @default(0)
  bounceCount     Int            @default(0)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  logs            EmailLog[]

  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
}

model EmailLog {
  id                 String         @id @default(uuid())
  campaignId         String?
  userId             String
  type               EmailLogType
  subject            String         @db.VarChar(500)
  status             EmailLogStatus @default(PENDING)
  providerMessageId  String?        @db.VarChar(255)
  error              String?        @db.Text
  createdAt          DateTime       @default(now())
  openedAt           DateTime?
  clickedAt          DateTime?

  campaign           EmailCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([userId])
  @@index([providerMessageId])
  @@index([status])
  @@index([createdAt])
}

// ─── Rental Data Pipeline ───────────────────────────────────

enum RentalSource {
  KHMER24
  REALESTATE_KH
  IPS_CAMBODIA
  CAMREALTY
  LONGTERMLETTINGS
  FAZWAZ
  HOMETOGO
}

enum JobType {
  DISCOVER
  PROCESS_QUEUE
  BUILD_INDEX
}

enum JobStatus {
  SUCCESS
  FAILED
}

enum QueueStatus {
  PENDING
  DONE
  RETRY
}

enum PropertyType {
  CONDO
  APARTMENT
  SERVICED_APARTMENT
  PENTHOUSE
  HOUSE
  VILLA
  TOWNHOUSE
  // Non-residential (legacy — no longer scraped)
  SHOPHOUSE
  LAND
  COMMERCIAL
  WAREHOUSE
  OFFICE
  OTHER
}

model RentalListing {
  id                 String       @id @default(cuid())
  source             RentalSource
  sourceListingId    String?      @db.VarChar(191)
  canonicalUrl       String       @unique @db.VarChar(2000)
  title              String       @db.VarChar(500)
  description        String?      @db.Text
  city               String       @default("Phnom Penh") @db.VarChar(100)
  district           String?      @db.VarChar(200)
  propertyType       PropertyType
  bedrooms           Int?
  bathrooms          Int?
  sizeSqm            Float?
  priceOriginal      String?      @db.VarChar(200)
  priceMonthlyUsd    Float?
  currency           String?      @db.VarChar(20)
  imageUrlsJson      String?      @db.Text
  amenitiesJson      String?      @db.Text
  postedAt           DateTime?
  firstSeenAt        DateTime     @default(now())
  lastSeenAt         DateTime
  latitude           Float?
  longitude          Float?
  isActive           Boolean      @default(true)
  manualOverride     Boolean      @default(false)
  contentFingerprint String?      @db.VarChar(64)
  descriptionRewritten   String?  @db.Text
  descriptionRewrittenAt DateTime?

  snapshots          RentalSnapshot[]
  aiReviews          RentalAiReview[]

  @@index([latitude, longitude])

  @@unique([source, sourceListingId])
  @@index([source, sourceListingId])
}

model RentalSnapshot {
  id              String       @id @default(cuid())
  listingId       String
  scrapedAt       DateTime     @default(now())
  city            String       @db.VarChar(100)
  district        String?      @db.VarChar(200)
  bedrooms        Int?
  propertyType    PropertyType
  priceOriginal   String?      @db.VarChar(200)
  priceMonthlyUsd Float?
  postedAt        DateTime?

  listing         RentalListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId, scrapedAt])
  @@index([scrapedAt])
}

// ─── AI Review (Gemini) ─────────────────────────────────────

model RentalAiReview {
  id              String        @id @default(cuid())
  listingId       String
  reviewedAt      DateTime      @default(now())
  suggestedType   PropertyType?
  isResidential   Boolean
  confidence      Float         // 0.0 – 1.0
  reason          String?       @db.VarChar(500)
  flagged         Boolean       @default(false)
  tokenCount      Int?

  listing         RentalListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([flagged])
  @@index([reviewedAt])
}

model RentalIndexDaily {
  id             String       @id @default(cuid())
  date           DateTime
  city           String       @db.VarChar(100)
  district       String?      @db.VarChar(200)
  bedrooms       Int?
  propertyType   PropertyType
  listingCount   Int
  medianPriceUsd Float?
  meanPriceUsd   Float?
  p25PriceUsd    Float?
  p75PriceUsd    Float?
  updatedAt      DateTime     @default(now()) @updatedAt

  @@unique([date, city, district, bedrooms, propertyType])
}

model ScrapeQueue {
  id              String       @id @default(cuid())
  source          RentalSource
  canonicalUrl    String       @db.VarChar(2000)
  sourceListingId String?      @db.VarChar(191)
  status          QueueStatus  @default(PENDING)
  priority        Int          @default(0)
  attempts        Int          @default(0)
  lastError       String?      @db.Text
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @default(now()) @updatedAt

  @@unique([source, canonicalUrl])
}

model JobRun {
  id              String        @id @default(cuid())
  jobType         JobType
  source          RentalSource?
  status          JobStatus
  startedAt       DateTime      @default(now())
  endedAt         DateTime?
  durationMs      Int?
  discoveredCount Int           @default(0)
  processedCount  Int           @default(0)
  insertedCount   Int           @default(0)
  updatedCount    Int           @default(0)
  snapshotCount   Int           @default(0)
  indexRowsCount  Int           @default(0)
  errorMessage    String?       @db.Text
  logEntries      Json?

  @@index([jobType])
  @@index([startedAt])
}

// ─── Rental Index Monthly ───────────────────────────────────

model RentalIndexMonthly {
  id             String       @id @default(cuid())
  yearMonth      String       @db.VarChar(7) // "2026-02"
  city           String       @db.VarChar(100)
  district       String?      @db.VarChar(200)
  bedrooms       Int?
  propertyType   PropertyType
  listingCount   Int
  medianRent     Float?
  meanRent       Float?
  p25Rent        Float?
  p75Rent        Float?
  updatedAt      DateTime     @default(now()) @updatedAt

  @@unique([yearMonth, city, district, bedrooms, propertyType])
  @@index([city, district])
  @@index([yearMonth])
}

// ─── Title Generation Log ───────────────────────────────────

model TitleGenerationLog {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  cityFocus       String   @db.VarChar(50)
  audienceFocus   String   @db.VarChar(20)
  selectedTopic   String   @db.VarChar(100)
  generatedTitle  String   @db.VarChar(300)
  primaryKeyword  String   @db.VarChar(200)
  modelUsed       String   @db.VarChar(100)
  tokenUsage      Int?
  titleLength     Int?
  accepted        Boolean  @default(true)
  constraintFailureReason String?  @db.VarChar(255)

  @@index([cityFocus, audienceFocus, createdAt])
  @@index([createdAt])
}
