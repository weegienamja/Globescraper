generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// ─── Auth.js models ───────────────────────────────────────────

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  DELETED
}

model User {
  id            String     @id @default(uuid())
  name          String?
  email         String     @unique @db.VarChar(255)
  emailVerified DateTime?
  passwordHash  String?    @db.VarChar(255)
  role          Role       @default(USER)
  status        UserStatus @default(ACTIVE)
  disabled      Boolean    @default(false)
  image         String?
  lastLoginAt   DateTime?
  deletedAt     DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  accounts      Account[]
  sessions      Session[]
  profile       Profile?
  auditLogs     AdminAuditLog[]
  connectionsSent     ConnectionRequest[] @relation("ConnectionSender")
  connectionsReceived ConnectionRequest[] @relation("ConnectionReceiver")
  connectionsLow      Connection[]  @relation("ConnectionLow")
  connectionsHigh     Connection[]  @relation("ConnectionHigh")
  conversationParticipants ConversationParticipant[]
  messagesSent        Message[]
  meetupsCreated      Meetup[]
  meetupAttendances   MeetupAttendee[]
  blocksInitiated     Block[]  @relation("Blocker")
  blocksReceived      Block[]  @relation("Blocked")
  reports             Report[]
  securityEvents      UserSecurityEvent[]
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Application models ──────────────────────────────────────

enum LeadStatus {
  NEW
  CONTACTED
  CONVERTED
  CLOSED
}

model Lead {
  id         String     @id @default(uuid())
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  name       String?
  email      String     @db.VarChar(255)
  message    String?    @db.Text
  source     String?
  status     LeadStatus @default(NEW)
  adminNotes String?    @db.Text
  deleted    Boolean    @default(false)

  @@index([email])
  @@index([createdAt])
  @@index([status])
}

model WaitlistEntry {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
}

model AdminAuditLog {
  id            String   @id @default(uuid())
  adminUserId   String
  actionType    String   @db.VarChar(50)
  targetType    String   @db.VarChar(50)
  targetId      String   @db.VarChar(191)
  targetUserId  String?  @db.VarChar(191)
  metadata      String?  @db.Text
  beforeJson    String?  @db.Text
  afterJson     String?  @db.Text
  createdAt     DateTime @default(now())

  admin         User     @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([targetUserId])
  @@index([createdAt])
}

// ─── Profile models ──────────────────────────────────────────

enum DegreeStatus {
  NONE
  IN_PROGRESS
  BACHELORS
  MASTERS
}

enum TeachingExperience {
  NONE
  LT1_YEAR
  ONE_TO_THREE
  THREE_PLUS
}

enum CertificationStatus {
  NONE
  IN_PROGRESS
  COMPLETED
}

enum TargetCountry {
  VIETNAM
  THAILAND
  CAMBODIA
  INDONESIA
  PHILIPPINES
  MALAYSIA
}

enum DesiredStartTimeline {
  ASAP
  ONE_TO_THREE_MONTHS
  THREE_TO_SIX_MONTHS
  RESEARCHING
}

enum SavingsBand {
  LOW
  MEDIUM
  HIGH
}

model Profile {
  id                    String              @id @default(uuid())
  userId                String              @unique
  passportCountry       String?             @db.VarChar(100)
  degreeStatus          DegreeStatus        @default(NONE)
  nativeEnglish         Boolean             @default(false)
  teachingExperience    TeachingExperience  @default(NONE)
  certificationStatus   CertificationStatus @default(NONE)
  desiredStartTimeline  DesiredStartTimeline @default(RESEARCHING)
  savingsBand           SavingsBand         @default(MEDIUM)
  displayName           String?             @db.VarChar(50)
  bio                   String?             @db.Text
  currentCountry        String?             @db.VarChar(100)
  currentCity           String?             @db.VarChar(100)
  avatarUrl             String?             @db.VarChar(500)
  visibility            ProfileVisibility   @default(MEMBERS_ONLY)
  meetupCoffee          Boolean             @default(false)
  meetupCityTour        Boolean             @default(false)
  meetupJobAdvice       Boolean             @default(false)
  meetupStudyGroup      Boolean             @default(false)
  meetupLanguageExchange Boolean            @default(false)
  hiddenFromCommunity   Boolean             @default(false)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetCountries       ProfileTargetCountry[]
  images                ProfileImage[]

  @@index([currentCountry])
  @@index([currentCity])
  @@index([visibility])
  @@index([updatedAt])
}

model ProfileTargetCountry {
  id        String        @id @default(uuid())
  profileId String
  country   TargetCountry

  profile   Profile       @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, country])
  @@index([profileId])
}

model ProfileImage {
  id        String   @id @default(uuid())
  profileId String
  url       String   @db.VarChar(500)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

// ─── Community enums ─────────────────────────────────────────

enum ProfileVisibility {
  PRIVATE
  MEMBERS_ONLY
  PUBLIC
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

enum MeetupVisibility {
  MEMBERS_ONLY
  PUBLIC
}

enum MeetupStatus {
  ACTIVE
  CANCELLED
}

enum AttendeeStatus {
  GOING
  INTERESTED
  LEFT
}

enum ReportTargetType {
  USER
  MEETUP
}

enum ReportReason {
  SPAM
  HARASSMENT
  SCAM
  OTHER
}

// ─── Community models ────────────────────────────────────────

model ConnectionRequest {
  id         String           @id @default(uuid())
  fromUserId String
  toUserId   String
  status     ConnectionStatus @default(PENDING)
  message    String?          @db.VarChar(300)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  fromUser   User             @relation("ConnectionSender", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User             @relation("ConnectionReceiver", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@index([toUserId])
  @@index([status])
  @@index([createdAt])
}

model Meetup {
  id              String           @id @default(uuid())
  createdByUserId String
  title           String           @db.VarChar(200)
  description     String           @db.Text
  country         String           @db.VarChar(100)
  city            String           @db.VarChar(100)
  dateTime        DateTime
  locationHint    String?          @db.VarChar(200)
  maxAttendees    Int?
  visibility      MeetupVisibility @default(MEMBERS_ONLY)
  status          MeetupStatus     @default(ACTIVE)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  createdBy       User             @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  attendees       MeetupAttendee[]

  @@index([country])
  @@index([city])
  @@index([dateTime])
  @@index([status])
  @@index([createdByUserId])
}

model MeetupAttendee {
  id        String         @id @default(uuid())
  meetupId  String
  userId    String
  status    AttendeeStatus @default(GOING)
  createdAt DateTime       @default(now())

  meetup    Meetup         @relation(fields: [meetupId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([meetupId, userId])
  @@index([userId])
}

model Block {
  id            String   @id @default(uuid())
  blockerUserId String
  blockedUserId String
  createdAt     DateTime @default(now())

  blocker       User     @relation("Blocker", fields: [blockerUserId], references: [id], onDelete: Cascade)
  blocked       User     @relation("Blocked", fields: [blockedUserId], references: [id], onDelete: Cascade)

  @@unique([blockerUserId, blockedUserId])
  @@index([blockedUserId])
}

model Report {
  id             String           @id @default(uuid())
  reporterUserId String
  targetType     ReportTargetType
  targetId       String           @db.VarChar(191)
  reason         ReportReason
  details        String?          @db.VarChar(1000)
  createdAt      DateTime         @default(now())

  reporter       User             @relation(fields: [reporterUserId], references: [id], onDelete: Cascade)

  @@index([reporterUserId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// ─── Canonical connections (new system) ──────────────────────

enum CanonicalConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Connection {
  id               String                    @id @default(uuid())
  userLowId        String
  userHighId       String
  requestedByUserId String
  status           CanonicalConnectionStatus @default(PENDING)
  createdAt        DateTime                  @default(now())
  acceptedAt       DateTime?
  updatedAt        DateTime                  @updatedAt

  userLow          User @relation("ConnectionLow",  fields: [userLowId],  references: [id], onDelete: Cascade)
  userHigh         User @relation("ConnectionHigh", fields: [userHighId], references: [id], onDelete: Cascade)

  @@unique([userLowId, userHighId])
  @@index([userHighId])
  @@index([status])
  @@index([requestedByUserId])
}

// ─── Messaging (DMs) ────────────────────────────────────────

enum ConversationType {
  DM
}

model Conversation {
  id           String             @id @default(uuid())
  type         ConversationType   @default(DM)
  createdAt    DateTime           @default(now())

  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  lastReadAt     DateTime?

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  body           String       @db.Text
  createdAt      DateTime     @default(now())
  deletedAt      DateTime?

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
}

// ─── Security events ────────────────────────────────────────

model UserSecurityEvent {
  id        String   @id @default(uuid())
  userId    String
  eventType String   @db.VarChar(50)
  ipAddress String?  @db.VarChar(45)
  userAgent String?  @db.VarChar(500)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

// ─── IP blocking ────────────────────────────────────────────

model BlockedIp {
  id        String    @id @default(uuid())
  ipCidr    String    @db.VarChar(50)
  reason    String?   @db.VarChar(500)
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([ipCidr])
  @@index([expiresAt])
}
